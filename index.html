<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Selection Study</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #4ade80;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        /* Screen styles */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Welcome screen */
        .welcome-content {
            text-align: center;
            max-width: 700px;
            margin: 0 auto;
        }

        .welcome-content h2 {
            font-size: 2rem;
            color: #1e293b;
            margin-bottom: 24px;
        }

        .welcome-content p {
            color: #64748b;
            font-size: 1.1rem;
            margin-bottom: 16px;
        }

        .highlight-box {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 24px;
            margin: 32px 0;
            text-align: left;
        }

        .highlight-box h3 {
            color: #0369a1;
            margin-bottom: 12px;
        }

        .highlight-box ul {
            color: #475569;
            padding-left: 20px;
        }

        .highlight-box li {
            margin-bottom: 8px;
        }

        .time-estimate {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 12px 20px;
            display: inline-block;
            color: #92400e;
            font-weight: 500;
            margin-bottom: 24px;
        }

        /* Question containers */
        .question-container {
            margin-bottom: 28px;
        }

        .question-label {
            display: block;
            color: #1e293b;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .radio-option:hover, .checkbox-option:hover {
            border-color: #8b5cf6;
            background: #faf5ff;
        }

        .radio-option.selected, .checkbox-option.selected {
            border-color: #8b5cf6;
            background: #f3e8ff;
        }

        .radio-option input, .checkbox-option input {
            width: 20px;
            height: 20px;
            accent-color: #8b5cf6;
        }

        /* Info box (attribute explanations) */
        .info-box {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 32px;
        }

        .info-box h3 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.25rem;
        }

        .attribute-explain {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .attribute-explain:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .attribute-explain strong {
            color: #7c3aed;
        }

        .attribute-explain p {
            color: #64748b;
            font-size: 0.95rem;
            margin-top: 4px;
        }

        /* GPA Scale visualization */
        .gpa-scale {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
        }

        .gpa-scale-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin: 20px 0 10px;
            padding: 0 20px;
        }

        .gpa-scale-line {
            height: 8px;
            background: linear-gradient(to right, #ef4444, #f59e0b, #22c55e, #22c55e);
            border-radius: 4px;
            margin: 0 20px;
        }

        .gpa-labels {
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            font-size: 0.875rem;
            color: #64748b;
        }

        /* Student card */
        .student-card {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-radius: 12px;
            padding: 28px;
            margin: 24px 0;
        }

        .student-card h3 {
            font-size: 1.5rem;
            margin-bottom: 16px;
        }

        .student-gpa {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .student-gpa-bar {
            height: 12px;
            background: rgba(255,255,255,0.3);
            border-radius: 6px;
            position: relative;
            margin-top: 12px;
        }

        .student-gpa-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: -4px;
            transform: translateX(-50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .course-requirement {
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        /* Choice set display */
        .choice-set-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .choice-set-header h2 {
            color: #1e293b;
            font-size: 1.5rem;
        }

        .course-context {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 16px;
            font-weight: 500;
        }

        .reminder-box {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            color: #92400e;
        }

        .instruction-text {
            color: #64748b;
            font-size: 1rem;
            max-width: 700px;
            margin: 0 auto 32px;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        @media (max-width: 900px) {
            .cards-container {
                grid-template-columns: 1fr;
            }
        }

        .course-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .course-card:hover {
            border-color: #8b5cf6;
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.15);
        }

        .card-header {
            padding: 16px;
            text-align: center;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .card-header.section-a { background: #dbeafe; color: #1e40af; }
        .card-header.section-b { background: #dcfce7; color: #166534; }
        .card-header.section-c { background: #fef3c7; color: #92400e; }

        .card-body {
            padding: 20px;
        }

        .attribute-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .attribute-row:last-child {
            border-bottom: none;
        }

        .attr-label {
            color: #64748b;
            font-size: 0.875rem;
        }

        .attr-value {
            font-weight: 600;
            color: #1e293b;
            text-align: right;
            font-size: 0.9rem;
        }

        .attr-value.banned { color: #dc2626; }
        .attr-value.guided { color: #2563eb; }
        .attr-value.unrestricted { color: #16a34a; }

        .point-input-container {
            padding: 16px 20px;
            background: #f8fafc;
            border-top: 2px solid #e2e8f0;
        }

        .point-input-container label {
            display: block;
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 8px;
        }

        .point-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease;
        }

        .point-input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* Points summary */
        .points-summary {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 24px;
        }

        .points-total {
            font-size: 2rem;
            font-weight: 700;
        }

        .points-total.valid { color: #16a34a; }
        .points-total.invalid { color: #dc2626; }

        .points-message {
            color: #64748b;
            margin-top: 8px;
        }

        .points-message.error {
            color: #dc2626;
            font-weight: 500;
        }

        /* Belief questions */
        .belief-section {
            background: #faf5ff;
            border: 2px solid #e9d5ff;
            border-radius: 12px;
            padding: 28px;
            margin-top: 32px;
        }

        .belief-section h3 {
            color: #7c3aed;
            margin-bottom: 24px;
        }

        .belief-question {
            margin-bottom: 24px;
        }

        .belief-question:last-child {
            margin-bottom: 0;
        }

        .belief-question label {
            display: block;
            color: #1e293b;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .grade-scale {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .grade-option {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .grade-option:hover {
            border-color: #8b5cf6;
        }

        .grade-option.selected {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        .slider-container {
            margin-top: 12px;
        }

        .slider-container input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: #e2e8f0;
            border-radius: 4px;
            outline: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #8b5cf6;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.875rem;
            color: #64748b;
        }

        .slider-value {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: #8b5cf6;
            margin-top: 8px;
        }

        /* Attention check styles */
        .attention-section {
            background: #fff7ed;
            border: 2px solid #fed7aa;
            border-radius: 12px;
            padding: 28px;
        }

        .attention-section h3 {
            color: #c2410c;
            margin-bottom: 16px;
        }

        .attention-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .attention-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .attention-option:hover {
            border-color: #f97316;
            background: #fff7ed;
        }

        .attention-option.selected {
            border-color: #f97316;
            background: #ffedd5;
        }

        .attention-option input {
            width: 20px;
            height: 20px;
            accent-color: #f97316;
        }

        /* WTP Section */
        .wtp-section {
            background: #f0f9ff;
            border: 2px solid #bae6fd;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 24px;
        }

        .wtp-section h3 {
            color: #0369a1;
            margin-bottom: 16px;
        }

        .wtp-course-card {
            background: white;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .wtp-course-card h4 {
            color: #0369a1;
            margin-bottom: 12px;
        }

        .wtp-course-card ul {
            color: #475569;
            padding-left: 20px;
            margin-bottom: 12px;
        }

        .wtp-course-card .rating {
            color: #f59e0b;
            font-weight: 500;
        }

        /* Buttons */
        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(22, 163, 74, 0.4);
        }

        .button-row {
            display: flex;
            justify-content: space-between;
            margin-top: 32px;
        }

        .button-row.center {
            justify-content: center;
        }

        /* Completion screen */
        .completion-content {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .completion-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .completion-icon svg {
            width: 50px;
            height: 50px;
            stroke: white;
            stroke-width: 3;
        }

        .completion-content h2 {
            color: #1e293b;
            font-size: 2rem;
            margin-bottom: 16px;
        }

        .completion-content p {
            color: #64748b;
            font-size: 1.1rem;
            margin-bottom: 32px;
        }

        .confirmation-code {
            background: #f1f5f9;
            padding: 16px 24px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.25rem;
            margin-bottom: 32px;
        }

        .confirmation-code span {
            color: #64748b;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
        }

        /* Error/warning messages */
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .warning-message {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
        }

        /* Prominent identical content banner */
        .identical-content-banner {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
            border: 3px solid #0369a1;
        }

        .identical-content-banner .highlight {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Course Selection Study</h1>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <span class="progress-text" id="progressText">0%</span>
            </div>
        </div>

        <div class="content">
            <!-- Screen 1: Welcome -->
            <div class="screen active" id="welcomeScreen">
                <div class="welcome-content">
                    <h2>Welcome!</h2>

                    <p style="font-size: 1.1rem; line-height: 1.8;">We are interested in <strong>your opinion</strong> about how college students pick their courses.</p>

                    <p style="font-size: 1.1rem; line-height: 1.8;">For this study, we will ask you to <strong>imagine a typical Binghamton student</strong> who needs to choose between different course sections. Each section has different rules about AI use, different grading, and different student reviews.</p>

                    <p style="font-size: 1.1rem; line-height: 1.8;">We will show you several scenarios and ask you to tell us <strong>which section this student would most likely choose</strong>. We will also ask what grade you think the student would earn.</p>

                    <div class="highlight-box" style="background: #fef3c7; border-color: #fcd34d;">
                        <p style="font-style: italic; color: #92400e; margin: 0;"><strong>We know these questions are not easy to answer.</strong> There is no right or wrong answer — we are just interested in what you personally think. Please try to consider each scenario carefully and tell us what you believe would happen.</p>
                    </div>

                    <div class="time-estimate">This should take about 8-10 minutes</div>

                    <p style="color: #64748b;">Your responses are anonymous and will be used for research purposes only.</p>

                    <div class="button-row center">
                        <button class="btn btn-primary" onclick="startSurvey()">Let's Start!</button>
                    </div>
                </div>
            </div>

            <!-- Screen 2: Consent & Eligibility -->
            <div class="screen" id="consentScreen">
                <h2 style="color: #1e293b; margin-bottom: 24px;">Eligibility & Consent</h2>

                <div class="info-box">
                    <p style="margin-bottom: 16px;">To participate, you must be:</p>
                    <ul style="padding-left: 24px; color: #475569;">
                        <li>Currently enrolled as an undergraduate student</li>
                        <li>18 years of age or older</li>
                    </ul>
                </div>

                <div class="question-container">
                    <label class="question-label">Do you confirm that you meet these eligibility requirements?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'eligibility', 'yes')">
                            <input type="radio" name="eligibility" value="yes">
                            <span>Yes, I am an undergraduate student aged 18 or older</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'eligibility', 'no')">
                            <input type="radio" name="eligibility" value="no">
                            <span>No, I do not meet the eligibility requirements</span>
                        </label>
                    </div>
                </div>

                <p style="color: #64748b; margin-top: 24px;">By clicking "Continue," you consent to participate in this study. You may exit at any time without penalty.</p>

                <div class="button-row center">
                    <button class="btn btn-primary" id="consentBtn" onclick="submitConsent()" disabled>Continue</button>
                </div>
            </div>

            <!-- Screen 3: Demographics -->
            <div class="screen" id="demographicsScreen">
                <h2 style="color: #1e293b; margin-bottom: 24px;">About You</h2>
                <p style="color: #64748b; margin-bottom: 32px;">These questions help us understand who is participating in our study.</p>

                <div class="question-container">
                    <label class="question-label">Q1. What is your current class standing?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'class_standing', '1')">
                            <input type="radio" name="class_standing" value="1"><span>First-year (Freshman)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'class_standing', '2')">
                            <input type="radio" name="class_standing" value="2"><span>Sophomore</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'class_standing', '3')">
                            <input type="radio" name="class_standing" value="3"><span>Junior</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'class_standing', '4')">
                            <input type="radio" name="class_standing" value="4"><span>Senior</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'class_standing', '5')">
                            <input type="radio" name="class_standing" value="5"><span>Other / Prefer not to say</span>
                        </label>
                    </div>
                </div>

                <div class="question-container">
                    <label class="question-label">Q2. What is your current cumulative GPA? (approximate)</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'resp_gpa', '1')">
                            <input type="radio" name="resp_gpa" value="1"><span>Below 2.5</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'resp_gpa', '2')">
                            <input type="radio" name="resp_gpa" value="2"><span>2.5 - 2.99</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'resp_gpa', '3')">
                            <input type="radio" name="resp_gpa" value="3"><span>3.0 - 3.49</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'resp_gpa', '4')">
                            <input type="radio" name="resp_gpa" value="4"><span>3.5 - 4.0</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'resp_gpa', '5')">
                            <input type="radio" name="resp_gpa" value="5"><span>Prefer not to say</span>
                        </label>
                    </div>
                </div>

                <div class="question-container">
                    <label class="question-label">Q3. What is your major or intended major?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'major', 'econ')">
                            <input type="radio" name="major" value="econ"><span>Economics</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'major', 'socsci')">
                            <input type="radio" name="major" value="socsci"><span>Other Social Science (e.g., Political Science, Sociology)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'major', 'business')">
                            <input type="radio" name="major" value="business"><span>Business / Management</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'major', 'stem')">
                            <input type="radio" name="major" value="stem"><span>STEM (e.g., Math, Computer Science, Engineering)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'major', 'humanities')">
                            <input type="radio" name="major" value="humanities"><span>Humanities (e.g., English, History, Philosophy)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'major', 'undecided')">
                            <input type="radio" name="major" value="undecided"><span>Undecided</span>
                        </label>
                    </div>
                </div>

                <div class="question-container">
                    <label class="question-label">Q4. How would you describe your confidence with quantitative coursework?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'quant_conf', '5')">
                            <input type="radio" name="quant_conf" value="5"><span>Very confident</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'quant_conf', '4')">
                            <input type="radio" name="quant_conf" value="4"><span>Somewhat confident</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'quant_conf', '3')">
                            <input type="radio" name="quant_conf" value="3"><span>Neutral</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'quant_conf', '2')">
                            <input type="radio" name="quant_conf" value="2"><span>Somewhat unconfident</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'quant_conf', '1')">
                            <input type="radio" name="quant_conf" value="1"><span>Very unconfident</span>
                        </label>
                    </div>
                </div>

                <div class="question-container">
                    <label class="question-label">Q5. How would you describe your confidence with writing-intensive coursework?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'writing_conf', '5')">
                            <input type="radio" name="writing_conf" value="5"><span>Very confident</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'writing_conf', '4')">
                            <input type="radio" name="writing_conf" value="4"><span>Somewhat confident</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'writing_conf', '3')">
                            <input type="radio" name="writing_conf" value="3"><span>Neutral</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'writing_conf', '2')">
                            <input type="radio" name="writing_conf" value="2"><span>Somewhat unconfident</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'writing_conf', '1')">
                            <input type="radio" name="writing_conf" value="1"><span>Very unconfident</span>
                        </label>
                    </div>
                </div>

                <div class="button-row center">
                    <button class="btn btn-primary" id="demoBtn" onclick="submitDemographics()" disabled>Continue</button>
                </div>
            </div>

            <!-- Screen 4: AI Experience -->
            <div class="screen" id="aiExperienceScreen">
                <h2 style="color: #1e293b; margin-bottom: 24px;">Your Experience with AI Tools</h2>

                <div class="question-container">
                    <label class="question-label">Q6. How often do you currently use AI tools (e.g., ChatGPT, Claude, Copilot) for your coursework?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'ai_freq', '1')">
                            <input type="radio" name="ai_freq" value="1"><span>Never</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'ai_freq', '2')">
                            <input type="radio" name="ai_freq" value="2"><span>Rarely (a few times per semester)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'ai_freq', '3')">
                            <input type="radio" name="ai_freq" value="3"><span>Sometimes (a few times per month)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'ai_freq', '4')">
                            <input type="radio" name="ai_freq" value="4"><span>Often (weekly)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'ai_freq', '5')">
                            <input type="radio" name="ai_freq" value="5"><span>Very often (daily or almost daily)</span>
                        </label>
                    </div>
                </div>

                <div class="question-container">
                    <label class="question-label">Q7. For which types of tasks do you typically use AI? (Select all that apply)</label>
                    <div class="checkbox-group" id="aiTasksGroup">
                        <label class="checkbox-option" onclick="toggleCheckbox(this, 'ai_tasks', 'brainstorm')">
                            <input type="checkbox" name="ai_tasks" value="brainstorm"><span>Brainstorming ideas</span>
                        </label>
                        <label class="checkbox-option" onclick="toggleCheckbox(this, 'ai_tasks', 'explain')">
                            <input type="checkbox" name="ai_tasks" value="explain"><span>Explaining difficult concepts</span>
                        </label>
                        <label class="checkbox-option" onclick="toggleCheckbox(this, 'ai_tasks', 'check')">
                            <input type="checkbox" name="ai_tasks" value="check"><span>Checking my work / getting feedback</span>
                        </label>
                        <label class="checkbox-option" onclick="toggleCheckbox(this, 'ai_tasks', 'writing')">
                            <input type="checkbox" name="ai_tasks" value="writing"><span>Drafting or editing written assignments</span>
                        </label>
                        <label class="checkbox-option" onclick="toggleCheckbox(this, 'ai_tasks', 'math')">
                            <input type="checkbox" name="ai_tasks" value="math"><span>Solving problem sets or math problems</span>
                        </label>
                        <label class="checkbox-option" onclick="toggleCheckbox(this, 'ai_tasks', 'code')">
                            <input type="checkbox" name="ai_tasks" value="code"><span>Generating code</span>
                        </label>
                        <label class="checkbox-option" onclick="toggleCheckbox(this, 'ai_tasks', 'none')">
                            <input type="checkbox" name="ai_tasks" value="none"><span>I don't use AI for coursework</span>
                        </label>
                    </div>
                </div>

                <div class="question-container">
                    <label class="question-label">Q8. How would you rate your skill at using AI tools effectively for academic work?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'ai_skill', '5')">
                            <input type="radio" name="ai_skill" value="5"><span>Expert (I know advanced prompting techniques)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'ai_skill', '4')">
                            <input type="radio" name="ai_skill" value="4"><span>Proficient (I can usually get what I need)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'ai_skill', '3')">
                            <input type="radio" name="ai_skill" value="3"><span>Basic (I use simple prompts)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'ai_skill', '2')">
                            <input type="radio" name="ai_skill" value="2"><span>Novice (I've tried it but struggle to get useful results)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'ai_skill', '1')">
                            <input type="radio" name="ai_skill" value="1"><span>No experience</span>
                        </label>
                    </div>
                </div>

                <div class="button-row center">
                    <button class="btn btn-primary" id="aiExpBtn" onclick="submitAIExperience()" disabled>Continue</button>
                </div>
            </div>

            <!-- Screen 5: Study Framing -->
            <div class="screen" id="framingScreen">
                <h2 style="color: #1e293b; margin-bottom: 24px;">How This Works</h2>

                <div class="info-box" style="font-size: 1.05rem; line-height: 1.8;">
                    <p style="margin-bottom: 20px;">In a moment, you will meet a Binghamton student who needs to pick a course for next semester. This student will have a certain <strong>GPA</strong> and need to take a certain <strong>type of course</strong>.</p>

                    <p style="margin-bottom: 20px;">The course has <strong>three sections</strong> to choose from. All three sections cover the same material and are taught by the same instructor. The only differences are:</p>

                    <ol style="padding-left: 24px; color: #475569; margin-bottom: 20px;">
                        <li style="margin-bottom: 8px;"><strong>AI Policy</strong> — rules about using AI on take-home work</li>
                        <li style="margin-bottom: 8px;"><strong>Assessment Structure</strong> — how much of the grade comes from exams vs. homework</li>
                        <li style="margin-bottom: 8px;"><strong>Student Reviews</strong> — teaching quality and difficulty based on past student feedback</li>
                    </ol>

                    <p style="margin-bottom: 20px;">We will show you <strong>9 scenarios</strong>. In each one, you will see three sections and tell us how likely the student would be to enroll in each by giving them points (adding up to 100).</p>

                    <p style="color: #64748b; font-style: italic;"><strong>Please don't worry</strong> — there is no right or wrong answer. We just want to know what you honestly think. Some questions might be hard, but please try your best!</p>
                </div>

                <div class="button-row center">
                    <button class="btn btn-primary" onclick="goToMeetStudent()">Continue</button>
                </div>
            </div>

            <!-- Screen 6: GPA Scale -->
            <div class="screen" id="gpaScaleScreen">
                <h2 style="color: #1e293b; margin-bottom: 24px;">Understanding the GPA Scale</h2>

                <p style="color: #64748b; margin-bottom: 24px;">The scale below shows student academic performance at Binghamton University.</p>

                <div class="gpa-scale">
                    <div class="gpa-scale-line"></div>
                    <div class="gpa-labels">
                        <div style="text-align: center;">
                            <strong>2.0</strong><br>
                            <span style="font-size: 0.75rem;">Academic<br>Probation</span>
                        </div>
                        <div style="text-align: center;">
                            <strong>2.5</strong><br>
                            <span style="font-size: 0.75rem;">Below<br>Average</span>
                        </div>
                        <div style="text-align: center;">
                            <strong>3.0</strong><br>
                            <span style="font-size: 0.75rem;">Average</span>
                        </div>
                        <div style="text-align: center;">
                            <strong>3.5</strong><br>
                            <span style="font-size: 0.75rem;">Above<br>Average</span>
                        </div>
                        <div style="text-align: center;">
                            <strong>4.0</strong><br>
                            <span style="font-size: 0.75rem;">Dean's<br>List</span>
                        </div>
                    </div>
                </div>

                <p style="color: #64748b; text-align: center; margin-top: 24px;">Most Binghamton students have GPAs between 2.8 and 3.4.</p>

                <div class="button-row center">
                    <button class="btn btn-primary" onclick="nextScreen('compCheckScreen')">Continue</button>
                </div>
            </div>

            <!-- Screen 7: Comprehension Checks -->
            <div class="screen" id="compCheckScreen">
                <h2 style="color: #1e293b; margin-bottom: 24px;">Quick Check</h2>
                <p style="color: #64748b; margin-bottom: 24px;">Please answer these questions to confirm you understand the GPA scale.</p>

                <div class="question-container">
                    <label class="question-label">A student with a 2.3 GPA would be considered:</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'comp1', 'above')">
                            <input type="radio" name="comp1" value="above"><span>Above average</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'comp1', 'average')">
                            <input type="radio" name="comp1" value="average"><span>Average</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'comp1', 'below')">
                            <input type="radio" name="comp1" value="below"><span>Below average / At risk of academic probation</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'comp1', 'deans')">
                            <input type="radio" name="comp1" value="deans"><span>On the Dean's List</span>
                        </label>
                    </div>
                    <div id="comp1Feedback" style="display: none;"></div>
                </div>

                <div class="question-container">
                    <label class="question-label">A student on the Dean's List would have approximately what GPA?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'comp2', '2.5')">
                            <input type="radio" name="comp2" value="2.5"><span>2.5</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'comp2', '3.0')">
                            <input type="radio" name="comp2" value="3.0"><span>3.0</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'comp2', '3.3')">
                            <input type="radio" name="comp2" value="3.3"><span>3.3</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'comp2', '3.7')">
                            <input type="radio" name="comp2" value="3.7"><span>3.7 or higher</span>
                        </label>
                    </div>
                    <div id="comp2Feedback" style="display: none;"></div>
                </div>

                <div class="button-row center">
                    <button class="btn btn-primary" id="compBtn" onclick="submitCompChecks()" disabled>Continue</button>
                </div>
            </div>

            <!-- Screen 8: Meet the Student -->
            <div class="screen" id="meetStudentScreen">
                <h2 style="color: #1e293b; margin-bottom: 24px;">Meet <span id="studentNameHeader">Emily</span></h2>

                <div class="student-card">
                    <h3 id="studentNameCard">Emily</h3>
                    <p><span id="studentNameIntro">Emily</span> is a sophomore at Binghamton University majoring in Economics.</p>

                    <div class="student-gpa">
                        <strong>Academic Standing: <span id="studentGPA">3.8</span> GPA</strong>
                        <div class="student-gpa-bar">
                            <div class="student-gpa-marker" id="studentGPAMarker" style="left: 90%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; opacity: 0.8;">
                            <span>2.0</span>
                            <span>2.5</span>
                            <span>3.0</span>
                            <span>3.5</span>
                            <span>4.0</span>
                        </div>
                    </div>

                    <p id="studentDescription" style="margin-top: 12px;">Emily is near the top of the class, on the Dean's List, and generally finds coursework manageable.</p>

                    <div class="course-requirement">
                        <strong>COURSE REQUIREMENT:</strong><br>
                        <span id="courseRequirement">Next semester, Emily needs to take a QUANTITATIVE course (like Statistics or Econometrics) to fulfill a requirement.</span>
                    </div>
                </div>

                <div class="identical-content-banner">
                    All three sections cover <span class="highlight">IDENTICAL CONTENT</span> - they only differ in the features shown below.
                </div>

                <p style="color: #64748b; margin-top: 24px;">Your task is to help <span id="studentNameTask">Emily</span> decide how likely <span id="studentPronoun">she</span> would be to enroll in each section.</p>

                <div class="button-row">
                    <button class="btn btn-secondary" onclick="goBack()">Back</button>
                    <button class="btn btn-primary" onclick="nextScreen('attributeScreen')">Continue</button>
                </div>
            </div>

            <!-- Screen 9: Attribute Definitions -->
            <div class="screen" id="attributeScreen">
                <h2 style="color: #1e293b; margin-bottom: 8px;">The Three Course Features</h2>
                <p style="color: #64748b; margin-bottom: 12px;">Each section differs only in these three features:</p>
                <p style="color: #1e293b; font-weight: 700; margin-bottom: 24px;">Everything else about the courses is identical (same content, same instructor, same schedule).</p>

                <!-- AI POLICY Block -->
                <div style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; color: white;">
                    <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; margin-bottom: 4px;">Feature 1</div>
                    <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 12px;">AI POLICY</div>
                    <div style="display: grid; gap: 8px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 8px;">
                            <strong>AI Prohibited</strong> — No AI allowed
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 8px;">
                            <strong>AI with Verification</strong> — AI allowed, must document use
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 8px;">
                            <strong>AI Permitted</strong> — AI allowed freely
                        </div>
                    </div>
                    <div style="margin-top: 12px; font-size: 0.9rem; opacity: 0.9;">
                        <em>Note: AI is never allowed on closed-book exams.</em>
                    </div>
                </div>

                <!-- ASSESSMENT STRUCTURE Block -->
                <div style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; color: white;">
                    <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; margin-bottom: 4px;">Feature 2</div>
                    <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 12px;">ASSESSMENT STRUCTURE</div>
                    <div style="display: grid; gap: 8px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 8px;">
                            <strong>80% Exam / 20% Take-Home</strong> — Grade mostly from exams
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 8px;">
                            <strong>50% Exam / 50% Take-Home</strong> — Equal weight
                        </div>
                    </div>
                    <div style="margin-top: 12px; font-size: 0.9rem; opacity: 0.9;">
                        <em>AI policy applies to take-home work only.</em>
                    </div>
                </div>

                <!-- STUDENT REVIEWS Block -->
                <div style="background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); border-radius: 12px; padding: 20px 24px; margin-bottom: 24px; color: white;">
                    <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; margin-bottom: 4px;">Feature 3</div>
                    <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 12px;">STUDENT REVIEWS</div>
                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 12px;">
                        These scores summarize past students' experiences.<br>
                        <strong>Quality</strong> = how effective the teaching is. <strong>Difficulty</strong> = how demanding the course feels.
                    </div>
                    <div style="display: grid; gap: 8px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 8px;">
                            <div style="display: flex; gap: 16px; margin-bottom: 4px;">
                                <span><strong>Quality:</strong> 4.7/5</span>
                                <span><strong>Difficulty:</strong> 4.3/5</span>
                            </div>
                            <span style="font-size: 0.9rem; opacity: 0.9;">Students report strong teaching, but the class is demanding.</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 8px;">
                            <div style="display: flex; gap: 16px; margin-bottom: 4px;">
                                <span><strong>Quality:</strong> 2.8/5</span>
                                <span><strong>Difficulty:</strong> 2.3/5</span>
                            </div>
                            <span style="font-size: 0.9rem; opacity: 0.9;">Students report weaker teaching, but the class is easier.</span>
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button class="btn btn-secondary" onclick="goBack()">Back</button>
                    <button class="btn btn-primary" onclick="nextScreen('practiceScreen')">I Understand - Continue</button>
                </div>
            </div>

            <!-- Screen 10: Practice Choice Set -->
            <div class="screen" id="practiceScreen">
                <div class="attention-section instructed" style="margin-bottom: 24px;">
                    <h3>PRACTICE ROUND</h3>
                    <p>Let's do a practice round to make sure everything is clear. This response will NOT be counted.</p>
                </div>

                <div class="identical-content-banner">
                    All three sections cover <span class="highlight">IDENTICAL CONTENT</span> - they only differ in the features shown below.
                </div>

                <div class="reminder-box">
                    <strong>REMINDER:</strong> <span id="practiceStudentName">Emily</span> has a <span id="practiceGPA">3.8</span> GPA and needs a <span id="practiceCourse">quantitative</span> course.
                </div>

                <p class="instruction-text">
                    Below are three sections. Allocate 100 points to show how likely <span id="practiceStudentName2">Emily</span> would be to enroll in each section.
                </p>

                <div class="cards-container" id="practiceCards">
                    <!-- Practice cards rendered by JS -->
                </div>

                <div class="points-summary">
                    <div class="points-total" id="practiceTotal">0 / 100</div>
                    <div class="points-message" id="practiceMessage">Enter points for each section (must total exactly 100)</div>
                </div>

                <p style="color: #64748b; background: #f0f9ff; padding: 12px 16px; border-radius: 8px; margin-bottom: 24px;">
                    <strong>TIP:</strong> If you think <span id="practiceTipName">Emily</span> would definitely choose one section, give it 100 points. If you think <span id="practiceTipName2">Emily</span> is torn between two options, you might give 50 points each. Use any distribution that reflects your belief.
                </p>

                <div class="button-row">
                    <button class="btn btn-secondary" onclick="goBack()">Back</button>
                    <button class="btn btn-primary" id="practiceBtn" onclick="submitPractice()" disabled>Submit Practice</button>
                </div>
            </div>

            <!-- Screen 11: Main Choice Sets -->
            <div class="screen" id="choiceScreen">
                <div class="choice-set-header">
                    <h2>Choice Set <span id="setNumber">1</span> of 9</h2>
                </div>

                <div class="identical-content-banner">
                    All three sections cover <span class="highlight">IDENTICAL CONTENT</span> - they only differ in the features shown below.
                </div>

                <div class="reminder-box" style="font-size: 1.1rem; padding: 16px 20px;">
                    <span id="choiceStudentName">Emily</span> has a <strong style="color: #7c3aed;"><span id="choiceGPA">3.8</span> GPA</strong> and needs to take a <strong style="color: #7c3aed;"><span id="choiceCourse">Quantitative</span></strong> course this semester.
                </div>

                <div class="identical-content-banner" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); margin-bottom: 24px;">
                    <strong>YOUR TASK:</strong> Allocate 100 points across the three sections to show how likely <span id="choiceStudentName2">Emily</span> would be to enroll in each.
                </div>

                <div class="cards-container" id="cardsContainer">
                    <!-- Cards dynamically generated -->
                </div>

                <div class="points-summary">
                    <div class="points-total" id="pointsTotal">0 / 100</div>
                    <div class="points-message" id="pointsMessage">Enter points for each section (must total exactly 100)</div>
                </div>

                <!-- Belief questions (shown for sets 3, 6, 8) -->
                <div class="belief-section" id="beliefSection" style="display: none;">
                    <h3>Follow-up Questions</h3>
                    <p style="color: #64748b; margin-bottom: 20px;">Think about the section <span id="beliefStudentName">Emily</span> is MOST likely to choose (the one you gave the most points).</p>

                    <div class="belief-question">
                        <label>What grade do you think <span id="beliefStudentName2">Emily</span> would earn in that section?</label>
                        <div class="grade-scale" id="beliefGradeScale">
                            <span class="grade-option" onclick="selectGrade(this, 'F')">F</span>
                            <span class="grade-option" onclick="selectGrade(this, 'D')">D</span>
                            <span class="grade-option" onclick="selectGrade(this, 'C')">C</span>
                            <span class="grade-option" onclick="selectGrade(this, 'C+')">C+</span>
                            <span class="grade-option" onclick="selectGrade(this, 'B-')">B-</span>
                            <span class="grade-option" onclick="selectGrade(this, 'B')">B</span>
                            <span class="grade-option" onclick="selectGrade(this, 'B+')">B+</span>
                            <span class="grade-option" onclick="selectGrade(this, 'A-')">A-</span>
                            <span class="grade-option" onclick="selectGrade(this, 'A')">A</span>
                        </div>
                    </div>

                    <div class="belief-question">
                        <label>How many hours per week would <span id="beliefStudentName3">Emily</span> spend on this course?</label>
                        <div class="slider-container">
                            <input type="range" id="beliefHours" min="0" max="20" value="8" oninput="updateHoursDisplay()">
                            <div class="slider-labels">
                                <span>0 hrs</span>
                                <span>10 hrs</span>
                                <span>20+ hrs</span>
                            </div>
                            <div class="slider-value" id="hoursValue">8 hrs/week</div>
                        </div>
                    </div>

                </div>

                <div class="button-row">
                    <button class="btn btn-secondary" onclick="previousSet()" id="prevBtn" style="visibility: hidden;">Previous</button>
                    <button class="btn btn-primary" onclick="nextSet()" id="nextBtn" disabled>Next</button>
                </div>
            </div>

            <!-- Attention Check: Name (after set 2) -->
            <div class="screen" id="nameCheckScreen">
                <div class="attention-section">
                    <h3>Quick Question</h3>
                    <p style="margin-bottom: 20px; color: #1e293b;">To make sure you're paying attention, please answer this question:</p>

                    <label class="question-label">In this survey, the hypothetical student's name is:</label>
                    <div class="attention-options" id="nameCheckOptions">
                        <label class="attention-option" onclick="selectAttention(this, 'nameCheck', 'Emily')">
                            <input type="radio" name="nameCheck" value="Emily"><span>Emily</span>
                        </label>
                        <label class="attention-option" onclick="selectAttention(this, 'nameCheck', 'Michael')">
                            <input type="radio" name="nameCheck" value="Michael"><span>Michael</span>
                        </label>
                        <label class="attention-option" onclick="selectAttention(this, 'nameCheck', 'Jordan')">
                            <input type="radio" name="nameCheck" value="Jordan"><span>Jordan</span>
                        </label>
                        <label class="attention-option" onclick="selectAttention(this, 'nameCheck', 'Taylor')">
                            <input type="radio" name="nameCheck" value="Taylor"><span>Taylor</span>
                        </label>
                    </div>
                </div>

                <div class="button-row center" style="margin-top: 24px;">
                    <button class="btn btn-primary" onclick="submitNameCheck()" id="nameCheckBtn" disabled>Continue</button>
                </div>
            </div>

            <!-- Screen 12: Direct AI Preference (validation measure) -->
            <div class="screen" id="directPrefScreen">
                <h2 style="color: #1e293b; margin-bottom: 24px;">One More Question</h2>

                <p style="color: #475569; margin-bottom: 24px;">
                    Setting aside grading structure and student reviews, imagine <span id="directPrefName">Emily</span> could choose between three otherwise identical course sections that differ ONLY in their AI policy.
                </p>

                <div class="question-container">
                    <label class="question-label">Which AI policy would <span id="directPrefName2">Emily</span> MOST prefer?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'ai_pref_most', 'Prohibited'); validateDirectPref()">
                            <input type="radio" name="ai_pref_most" value="Prohibited">
                            <span><strong>AI Prohibited</strong> — No AI tools permitted on any assignments</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'ai_pref_most', 'Verification'); validateDirectPref()">
                            <input type="radio" name="ai_pref_most" value="Verification">
                            <span><strong>AI with Verification</strong> — AI allowed with prompt log + output verification</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'ai_pref_most', 'Permitted'); validateDirectPref()">
                            <input type="radio" name="ai_pref_most" value="Permitted">
                            <span><strong>AI Permitted</strong> — AI allowed with no extra requirements</span>
                        </label>
                    </div>
                </div>

                <div class="question-container">
                    <label class="question-label">Which AI policy would <span id="directPrefName3">Emily</span> LEAST prefer?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'ai_pref_least', 'Prohibited'); validateDirectPref()">
                            <input type="radio" name="ai_pref_least" value="Prohibited">
                            <span><strong>AI Prohibited</strong></span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'ai_pref_least', 'Verification'); validateDirectPref()">
                            <input type="radio" name="ai_pref_least" value="Verification">
                            <span><strong>AI with Verification</strong></span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'ai_pref_least', 'Permitted'); validateDirectPref()">
                            <input type="radio" name="ai_pref_least" value="Permitted">
                            <span><strong>AI Permitted</strong></span>
                        </label>
                    </div>
                </div>

                <div class="button-row">
                    <button class="btn btn-secondary" onclick="goBack()">Back</button>
                    <button class="btn btn-primary" id="directPrefBtn" onclick="submitDirectPref()" disabled>Continue</button>
                </div>
            </div>

            <!-- Screen 13: WTP Questions -->
            <div class="screen" id="wtpScreen">
                <h2 style="color: #1e293b; margin-bottom: 24px;">AI Skills Training Opportunity</h2>

                <p style="color: #64748b; margin-bottom: 24px;">Imagine that before the semester begins, <span id="wtpStudentName">Emily</span> discovers a highly-rated online course on AI prompt engineering.</p>

                <div class="wtp-course-card">
                    <h4>"Effective AI Use for Academic Success"</h4>
                    <ul>
                        <li>How to write effective prompts</li>
                        <li>How to verify and fact-check AI outputs</li>
                        <li>How to integrate AI into studying and assignments</li>
                        <li>Strategies for learning WITH AI (not just FROM AI)</li>
                    </ul>
                    <p class="rating">Rating: 4.8/5 from 500+ students</p>
                    <p style="color: #64748b;">Duration: 4 weeks (self-paced)</p>
                </div>

                <div class="question-container">
                    <label class="question-label">What is the MAXIMUM <span id="wtpStudentName2">Emily</span> would pay for this course?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'wtp_money', '0')">
                            <input type="radio" name="wtp_money" value="0"><span>$0</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_money', '25')">
                            <input type="radio" name="wtp_money" value="25"><span>$25</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_money', '50')">
                            <input type="radio" name="wtp_money" value="50"><span>$50</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_money', '75')">
                            <input type="radio" name="wtp_money" value="75"><span>$75</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_money', '100')">
                            <input type="radio" name="wtp_money" value="100"><span>$100</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_money', '150')">
                            <input type="radio" name="wtp_money" value="150"><span>$150</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_money', '200')">
                            <input type="radio" name="wtp_money" value="200"><span>$200+</span>
                        </label>
                    </div>
                </div>

                <div class="question-container">
                    <label class="question-label">How many hours per week would <span id="wtpStudentName3">Emily</span> be willing to spend on this course during the 4 weeks before the semester?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'wtp_time', '0')">
                            <input type="radio" name="wtp_time" value="0"><span>0 hours</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_time', '1-2')">
                            <input type="radio" name="wtp_time" value="1-2"><span>1-2 hours</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_time', '3-4')">
                            <input type="radio" name="wtp_time" value="3-4"><span>3-4 hours</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_time', '5-6')">
                            <input type="radio" name="wtp_time" value="5-6"><span>5-6 hours</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_time', '7-8')">
                            <input type="radio" name="wtp_time" value="7-8"><span>7-8 hours</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_time', '10+')">
                            <input type="radio" name="wtp_time" value="10+"><span>10+ hours</span>
                        </label>
                    </div>
                </div>

                <div class="question-container">
                    <label class="question-label">If the course were FREE, how likely is <span id="wtpStudentName4">Emily</span> to enroll?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'wtp_free', '1')">
                            <input type="radio" name="wtp_free" value="1"><span>Very Unlikely</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_free', '2')">
                            <input type="radio" name="wtp_free" value="2"><span>Unlikely</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_free', '3')">
                            <input type="radio" name="wtp_free" value="3"><span>Neutral</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_free', '4')">
                            <input type="radio" name="wtp_free" value="4"><span>Likely</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'wtp_free', '5')">
                            <input type="radio" name="wtp_free" value="5"><span>Very Likely</span>
                        </label>
                    </div>
                </div>

                <div class="button-row">
                    <button class="btn btn-secondary" onclick="goBack()">Back</button>
                    <button class="btn btn-primary" id="wtpBtn" onclick="submitWTP()" disabled>Continue</button>
                </div>
            </div>

            <!-- Screen 13: Manipulation Checks -->
            <div class="screen" id="manipCheckScreen">
                <h2 style="color: #1e293b; margin-bottom: 24px;">Final Questions</h2>

                <h3 style="color: #1e293b; margin-bottom: 20px;">MANIPULATION CHECKS</h3>

                <div class="question-container">
                    <label class="question-label">In this study, <span id="manipStudentName7">Emily</span>'s GPA was:</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'manip_gpa', '2.5')">
                            <input type="radio" name="manip_gpa" value="2.5"><span>2.5 (below average)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'manip_gpa', '3.0')">
                            <input type="radio" name="manip_gpa" value="3.0"><span>3.0 (average)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'manip_gpa', '3.8')">
                            <input type="radio" name="manip_gpa" value="3.8"><span>3.8 (above average)</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'manip_gpa', 'dont_remember')">
                            <input type="radio" name="manip_gpa" value="dont_remember"><span>I don't remember</span>
                        </label>
                    </div>
                </div>

                <div class="question-container">
                    <label class="question-label">The course <span id="manipStudentName8">Emily</span> needed was:</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectOption(this, 'manip_course', 'quant')">
                            <input type="radio" name="manip_course" value="quant"><span>A Quantitative (Math/Statistics intensive) course</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'manip_course', 'writing')">
                            <input type="radio" name="manip_course" value="writing"><span>A Qualitative (writing intensive) course</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'manip_course', 'lab')">
                            <input type="radio" name="manip_course" value="lab"><span>A laboratory course</span>
                        </label>
                        <label class="radio-option" onclick="selectOption(this, 'manip_course', 'dont_remember')">
                            <input type="radio" name="manip_course" value="dont_remember"><span>I don't remember</span>
                        </label>
                    </div>
                </div>

                <div class="button-row">
                    <button class="btn btn-secondary" onclick="goBack()">Back</button>
                    <button class="btn btn-primary" id="manipBtn" onclick="submitManipChecks()" disabled>Continue</button>
                </div>
            </div>

            <!-- Screen 14: Completion -->
            <div class="screen" id="completionScreen">
                <div class="completion-content">
                    <div class="completion-icon">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <h2>Thank You!</h2>
                    <p>You have successfully completed the survey.</p>

                    <div class="info-box" style="text-align: left; margin-bottom: 24px;">
                        <h3 style="margin-bottom: 12px;">About This Study</h3>
                        <p style="color: #64748b;">This research examines how AI policies in courses affect student enrollment decisions. We are particularly interested in whether students' beliefs about performance outcomes vary based on:</p>
                        <ul style="color: #64748b; padding-left: 24px; margin-top: 12px;">
                            <li>The student's academic ability (high vs. low GPA)</li>
                            <li>The type of course (Quantitative vs. Qualitative)</li>
                            <li>The AI policy (prohibited, guided, or unrestricted)</li>
                        </ul>
                        <p style="color: #64748b; margin-top: 12px;">Your responses will help universities design AI policies that support student learning while maintaining academic integrity.</p>
                    </div>

                    <div class="confirmation-code">
                        <span>Your Confirmation Code:</span><br>
                        <strong id="confirmationCode"></strong>
                    </div>

                    <p style="color: #64748b; margin-bottom: 24px;">Please save this code for your records.</p>

                    <button class="btn btn-success" onclick="downloadResults()">Download My Responses (CSV)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // BLOCK DATA (V9: 12 profiles, 3 AI x 2 grading x 2 rating)
        // ============================================
        // Profile structure: id, ai, grading, rating
        // Grading: 80/20 or 50/50
        // Rating: HighQual (high teaching, tough grading) or LowQual (lower teaching, easy grading)
        const PROFILES = [
            { id: 1, ai: 'Banned', grading: '80/20', rating: 'HighQual' },
            { id: 2, ai: 'Banned', grading: '80/20', rating: 'LowQual' },
            { id: 3, ai: 'Banned', grading: '50/50', rating: 'HighQual' },
            { id: 4, ai: 'Banned', grading: '50/50', rating: 'LowQual' },
            { id: 5, ai: 'Guided', grading: '80/20', rating: 'HighQual' },
            { id: 6, ai: 'Guided', grading: '80/20', rating: 'LowQual' },
            { id: 7, ai: 'Guided', grading: '50/50', rating: 'HighQual' },
            { id: 8, ai: 'Guided', grading: '50/50', rating: 'LowQual' },
            { id: 9, ai: 'Unrestricted', grading: '80/20', rating: 'HighQual' },
            { id: 10, ai: 'Unrestricted', grading: '80/20', rating: 'LowQual' },
            { id: 11, ai: 'Unrestricted', grading: '50/50', rating: 'HighQual' },
            { id: 12, ai: 'Unrestricted', grading: '50/50', rating: 'LowQual' }
        ];

        // 9 choice sets per block with 2-3-3-1 structure:
        // - Sets 1-2: AI-only (only AI policy varies, isolates pure AI preference)
        // - Sets 3-5: Assessment-varies (AI + assessment vary, trade AI vs exam weight)
        // - Sets 6-8: Reviews-varies (AI + reviews vary, trade AI vs quality/difficulty)
        // - Set 9: Both-vary (AI + assessment + reviews vary, exploratory heterogeneity)
        // Optimized with odd-one-out balancing (each AI policy is "odd" once per vary-type)
        const BLOCKS = {
            1: [
                { profiles: [2, 6, 10], type: 'ai_only' },        // Set 1
                { profiles: [3, 7, 11], type: 'ai_only' },        // Set 2
                { profiles: [1, 5, 11], type: 'assess_varies' },  // Set 3 (odd=Unrestricted)
                { profiles: [2, 8, 10], type: 'assess_varies' },  // Set 4 (odd=Guided)
                { profiles: [1, 7, 11], type: 'assess_varies' },  // Set 5 (odd=Banned)
                { profiles: [1, 6, 9], type: 'reviews_varies' },  // Set 6 (odd=Guided)
                { profiles: [3, 8, 12], type: 'reviews_varies' }, // Set 7 (odd=Banned)
                { profiles: [4, 8, 11], type: 'reviews_varies' }, // Set 8 (odd=Unrestricted)
                { profiles: [4, 5, 10], type: 'both_vary' }       // Set 9
            ],
            2: [
                { profiles: [2, 6, 10], type: 'ai_only' },        // Set 1
                { profiles: [1, 5, 9], type: 'ai_only' },         // Set 2
                { profiles: [4, 6, 10], type: 'assess_varies' },  // Set 3 (odd=Banned)
                { profiles: [3, 5, 11], type: 'assess_varies' },  // Set 4 (odd=Guided)
                { profiles: [3, 7, 9], type: 'assess_varies' },   // Set 5 (odd=Unrestricted)
                { profiles: [2, 5, 10], type: 'reviews_varies' }, // Set 6 (odd=Guided)
                { profiles: [3, 7, 12], type: 'reviews_varies' }, // Set 7 (odd=Unrestricted)
                { profiles: [4, 7, 11], type: 'reviews_varies' }, // Set 8 (odd=Banned)
                { profiles: [2, 8, 11], type: 'both_vary' }       // Set 9
            ],
            3: [
                { profiles: [4, 8, 12], type: 'ai_only' },        // Set 1
                { profiles: [3, 7, 11], type: 'ai_only' },        // Set 2
                { profiles: [1, 7, 9], type: 'assess_varies' },   // Set 3 (odd=Guided)
                { profiles: [3, 5, 9], type: 'assess_varies' },   // Set 4 (odd=Banned)
                { profiles: [2, 6, 12], type: 'assess_varies' },  // Set 5 (odd=Unrestricted)
                { profiles: [1, 6, 10], type: 'reviews_varies' }, // Set 6 (odd=Banned)
                { profiles: [2, 6, 9], type: 'reviews_varies' },  // Set 7 (odd=Unrestricted)
                { profiles: [4, 7, 12], type: 'reviews_varies' }, // Set 8 (odd=Guided)
                { profiles: [2, 5, 11], type: 'both_vary' }       // Set 9
            ]
        };

        function getBlockChoiceSets(blockNum) {
            return BLOCKS[blockNum].map(set => ({
                profiles: set.profiles.map(id => getProfile(id)),
                type: set.type
            }));
        }

        function getProfile(id) {
            return PROFILES.find(p => p.id === id);
        }

        // Display labels
        const AI_LABELS = {
            'Banned': 'AI Prohibited',
            'Guided': 'AI with Verification',
            'Unrestricted': 'AI Permitted'
        };

        // Student Reviews - Quality (teaching effectiveness) + Difficulty (how demanding)
        const RATING_LABELS = {
            'HighQual': {
                quality: '4.7/5',
                difficulty: '4.3/5',
                summary: 'Students report strong teaching, but the class is demanding.'
            },
            'LowQual': {
                quality: '2.8/5',
                difficulty: '2.3/5',
                summary: 'Students report weaker teaching, but the class is easier.'
            }
        };

        // ============================================
        // STATE
        // ============================================
        let state = {
            respondentId: '',
            startTime: null,
            // Between-subjects assignment
            cell: 0, // 1-8 (now includes gender)
            block: 0, // 1-3 for choice set blocking
            studentAbility: '', // 'high' or 'low'
            courseType: '', // 'quantitative' or 'writing'
            studentGender: '', // 'female' or 'male'
            studentName: '', // 'Emily' or 'Michael'
            studentPronoun: '', // 'she' or 'he'
            studentPronounPossessive: '', // 'her' or 'his'
            // Responses
            demographics: {},
            aiExperience: {},
            compChecks: { check1: null, check2: null },
            practiceResponse: {},
            choiceResponses: [],
            choiceSets: [], // Will be populated based on block assignment
            setDisplayOrder: [], // Maps display position to original set ID
            currentSetIndex: 0,
            sectionLabelOrders: [],
            beliefSets: [1, 4, 7], // Sets 2, 5, 8 (0-indexed) - ask beliefs on these sets
            currentBeliefs: {},
            nameCheckAnswer: null,
            directPref: { most: null, least: null },
            wtpResponses: {},
            manipChecks: {},
            // Quality flags
            flags: {
                comprehension: false,
                attention_name: false,
                speedster: false,
                straightliner: false
            },
            // Screen history for back button
            screenHistory: []
        };

        // ============================================
        // UTILITY FUNCTIONS (DETERMINISTIC ASSIGNMENT)
        // ============================================

        // Seeded PRNG (Mulberry32) - produces deterministic random numbers
        function mulberry32(seed) {
            return function() {
                let t = seed += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            };
        }

        // Hash function (cyrb53) - converts string to numeric seed
        function hashString(str, seed = 0) {
            let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
            for (let i = 0, ch; i < str.length; i++) {
                ch = str.charCodeAt(i);
                h1 = Math.imul(h1 ^ ch, 2654435761);
                h2 = Math.imul(h2 ^ ch, 1597334677);
            }
            h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507);
            h1 ^= Math.imul(h2 ^ (h2 >>> 13), 3266489909);
            h2 = Math.imul(h2 ^ (h2 >>> 16), 2246822507);
            h2 ^= Math.imul(h1 ^ (h1 >>> 13), 3266489909);
            return 4294967296 * (2097151 & h2) + (h1 >>> 0);
        }

        // Get or create respondent ID (persists across refreshes)
        function getOrCreateRespondentId() {
            // Check URL parameter first (for platform IDs like Prolific/MTurk)
            const urlParams = new URLSearchParams(window.location.search);
            const urlId = urlParams.get('PROLIFIC_PID') || urlParams.get('workerId') || urlParams.get('respondent_id');
            if (urlId) {
                localStorage.setItem('vignette_respondent_id', urlId);
                return urlId;
            }

            // Check localStorage
            let storedId = localStorage.getItem('vignette_respondent_id');
            if (storedId) {
                return storedId;
            }

            // Generate new ID
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let id = '';
            for (let i = 0; i < 8; i++) {
                id += chars[Math.floor(Math.random() * chars.length)];
            }
            localStorage.setItem('vignette_respondent_id', id);
            return id;
        }

        // Seeded shuffle (Fisher-Yates with PRNG)
        function seededShuffle(array, rng) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(rng() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // Regular shuffle (for non-critical randomization)
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function randomChoice(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function updateProgress() {
            const totalSteps = 15;
            let currentStep = 0;

            const currentScreen = document.querySelector('.screen.active');
            const screenOrder = ['welcomeScreen', 'consentScreen', 'demographicsScreen', 'aiExperienceScreen',
                'framingScreen', 'gpaScaleScreen', 'compCheckScreen', 'meetStudentScreen', 'attributeScreen',
                'practiceScreen', 'choiceScreen', 'directPrefScreen', 'wtpScreen', 'manipCheckScreen', 'completionScreen'];

            const idx = screenOrder.indexOf(currentScreen.id);
            if (idx >= 0) {
                if (currentScreen.id === 'choiceScreen') {
                    const totalSets = state.choiceSets.length || 9;
                    currentStep = 10 + (state.currentSetIndex / totalSets) * 0.8;
                } else {
                    currentStep = idx;
                }
            }

            const pct = Math.round((currentStep / totalSteps) * 100);
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('progressText').textContent = pct + '%';
        }

        function showScreen(screenId, addToHistory = true) {
            const currentScreen = document.querySelector('.screen.active');
            if (currentScreen && addToHistory && currentScreen.id !== screenId) {
                state.screenHistory.push(currentScreen.id);
            }
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            updateProgress();
            window.scrollTo(0, 0);
        }

        function nextScreen(screenId) {
            showScreen(screenId);
        }

        function goBack() {
            if (state.screenHistory.length > 0) {
                const previousScreen = state.screenHistory.pop();
                showScreen(previousScreen, false);
            }
        }

        // ============================================
        // OPTION SELECTION HANDLERS
        // ============================================
        function selectOption(el, name, value) {
            // Clear previous selection
            el.closest('.radio-group').querySelectorAll('.radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            el.classList.add('selected');
            el.querySelector('input').checked = true;

            // Validate current screen
            validateCurrentScreen();
        }

        function toggleCheckbox(el, name, value) {
            const input = el.querySelector('input');
            input.checked = !input.checked;
            el.classList.toggle('selected', input.checked);

            // Special handling for "I don't use AI" option
            if (name === 'ai_tasks' && value === 'none' && input.checked) {
                // Uncheck all other options
                document.querySelectorAll('input[name="ai_tasks"]').forEach(cb => {
                    if (cb.value !== 'none') {
                        cb.checked = false;
                        cb.closest('.checkbox-option').classList.remove('selected');
                    }
                });
            } else if (name === 'ai_tasks' && value !== 'none' && input.checked) {
                // Uncheck "none" option
                const noneInput = document.querySelector('input[name="ai_tasks"][value="none"]');
                if (noneInput) {
                    noneInput.checked = false;
                    noneInput.closest('.checkbox-option').classList.remove('selected');
                }
            }

            validateCurrentScreen();
        }

        function selectAttention(el, name, value) {
            el.closest('.attention-options').querySelectorAll('.attention-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            el.classList.add('selected');
            el.querySelector('input').checked = true;
            state[name === 'nameCheck' ? 'nameCheckAnswer' : name] = value;
            document.getElementById('nameCheckBtn').disabled = false;
        }

        function selectGrade(el, value) {
            document.querySelectorAll('#beliefGradeScale .grade-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            el.classList.add('selected');
            state.currentBeliefs.grade = value;
            validatePoints();
        }

        function updateHoursDisplay() {
            const val = document.getElementById('beliefHours').value;
            document.getElementById('hoursValue').textContent = val >= 20 ? '20+ hrs/week' : val + ' hrs/week';
            state.currentBeliefs.hours = parseInt(val);
        }

        // ============================================
        // VALIDATION FUNCTIONS
        // ============================================
        function validateCurrentScreen() {
            const currentScreen = document.querySelector('.screen.active');

            if (currentScreen.id === 'consentScreen') {
                const selected = document.querySelector('input[name="eligibility"]:checked');
                document.getElementById('consentBtn').disabled = !selected;
            }
            else if (currentScreen.id === 'demographicsScreen') {
                const fields = ['class_standing', 'resp_gpa', 'major', 'quant_conf', 'writing_conf'];
                const allFilled = fields.every(f => document.querySelector(`input[name="${f}"]:checked`));
                document.getElementById('demoBtn').disabled = !allFilled;
            }
            else if (currentScreen.id === 'aiExperienceScreen') {
                const freq = document.querySelector('input[name="ai_freq"]:checked');
                const skill = document.querySelector('input[name="ai_skill"]:checked');
                const tasks = document.querySelectorAll('input[name="ai_tasks"]:checked');
                document.getElementById('aiExpBtn').disabled = !(freq && skill && tasks.length > 0);
            }
            else if (currentScreen.id === 'compCheckScreen') {
                const c1 = document.querySelector('input[name="comp1"]:checked');
                const c2 = document.querySelector('input[name="comp2"]:checked');
                document.getElementById('compBtn').disabled = !(c1 && c2);
            }
            else if (currentScreen.id === 'wtpScreen') {
                const fields = ['wtp_money', 'wtp_time', 'wtp_free'];
                const allFilled = fields.every(f => document.querySelector(`input[name="${f}"]:checked`));
                document.getElementById('wtpBtn').disabled = !allFilled;
            }
            else if (currentScreen.id === 'manipCheckScreen') {
                const gpa = document.querySelector('input[name="manip_gpa"]:checked');
                const course = document.querySelector('input[name="manip_course"]:checked');
                document.getElementById('manipBtn').disabled = !(gpa && course);
            }
        }

        // ============================================
        // SUBMISSION HANDLERS
        // ============================================
        function startSurvey() {
            // ============================================
            // DETERMINISTIC ASSIGNMENT (reproducible from respondent ID)
            // ============================================

            // Step 0: Get or create respondent ID (persists on refresh)
            state.respondentId = getOrCreateRespondentId();
            state.startTime = Date.now();

            // Step 1: Hash respondent ID to get master seed
            const masterSeed = hashString(state.respondentId);

            // Step 2: Derive cell (1-8) and block (1-3) deterministically
            // This prevents "refresh until you get a nicer student"
            state.cell = (masterSeed % 8) + 1;  // 1-8
            state.block = ((masterSeed >> 3) % 3) + 1;  // 1-3 (use different bits)

            // Ability: cells 1-4 = high, cells 5-8 = low
            state.studentAbility = state.cell <= 4 ? 'high' : 'low';

            // Course type: odd cells = quantitative, even cells = writing
            state.courseType = (state.cell % 2 === 1) ? 'quantitative' : 'writing';

            // Gender: cells 1,2,5,6 = female (Emily), cells 3,4,7,8 = male (Michael)
            state.studentGender = (state.cell <= 2 || (state.cell >= 5 && state.cell <= 6)) ? 'female' : 'male';
            state.studentName = state.studentGender === 'female' ? 'Emily' : 'Michael';
            state.studentPronoun = state.studentGender === 'female' ? 'she' : 'he';
            state.studentPronounPossessive = state.studentGender === 'female' ? 'her' : 'his';

            // Step 3: Get block's choice sets (each set = 3 profiles)
            const originalSets = getBlockChoiceSets(state.block);

            // Step 4: Seeded shuffle for set display order (reproducible)
            const setOrderRng = mulberry32(masterSeed + 1000);
            const setIndices = originalSets.map((set, idx) => ({ set, originalIndex: idx + 1 }));
            const shuffledSets = seededShuffle([...setIndices], setOrderRng);
            state.choiceSets = shuffledSets.map(item => item.set);
            state.setDisplayOrder = shuffledSets.map(item => item.originalIndex);

            // Step 5: Seeded shuffle for A/B/C labels within each set (reproducible)
            state.sectionLabelOrders = [];
            for (let i = 0; i < state.choiceSets.length; i++) {
                const labelRng = mulberry32(masterSeed + 2000 + i);
                state.sectionLabelOrders.push(seededShuffle([0, 1, 2], labelRng));
            }

            // Log assignment for debugging
            console.log('Deterministic assignment:', {
                respondentId: state.respondentId,
                masterSeed: masterSeed,
                cell: state.cell,
                block: state.block,
                setDisplayOrder: state.setDisplayOrder
            });

            // Go directly to framing screen (skip demographics, AI experience)
            showScreen('framingScreen');
        }

        function goToMeetStudent() {
            // Set up student card and go directly to meet student (skip GPA scale and comp check)
            setupStudentCard();
            showScreen('meetStudentScreen');
        }

        function setupStudentCard() {
            const name = state.studentName;
            const pronoun = state.studentPronoun;
            const gpa = state.studentAbility === 'high' ? '3.8' : '2.5';
            const markerPos = state.studentAbility === 'high' ? '90%' : '25%';

            const description = state.studentAbility === 'high'
                ? `${name} is near the top of the class, on the Dean's List, and generally finds coursework manageable.`
                : `${name} is below average in the class and often finds coursework challenging. ${name} has struggled in some previous courses.`;

            const courseText = state.courseType === 'quantitative'
                ? `Next semester, ${name} needs to take a QUANTITATIVE (Math/Statistics intensive) course (like Statistics or Econometrics) to fulfill a requirement.`
                : `Next semester, ${name} needs to take a QUALITATIVE (writing intensive) course (like Literature or History) to fulfill a requirement.`;

            // Update meet student screen
            document.getElementById('studentNameHeader').textContent = name;
            document.getElementById('studentNameCard').textContent = name;
            document.getElementById('studentNameIntro').textContent = name;
            document.getElementById('studentGPA').textContent = gpa;
            document.getElementById('studentGPAMarker').style.left = markerPos;
            document.getElementById('studentDescription').textContent = description;
            document.getElementById('courseRequirement').textContent = courseText;
            document.getElementById('studentNameTask').textContent = name;
            document.getElementById('studentPronoun').textContent = pronoun;

            // Update practice screen
            document.getElementById('practiceStudentName').textContent = name;
            document.getElementById('practiceStudentName2').textContent = name;
            document.getElementById('practiceGPA').textContent = gpa;
            document.getElementById('practiceCourse').textContent = state.courseType === 'quantitative' ? 'Quantitative (Math/Statistics intensive)' : 'Qualitative (writing intensive)';

            // Update choice screen
            document.getElementById('choiceStudentName').textContent = name;
            document.getElementById('choiceStudentName2').textContent = name;
            document.getElementById('choiceGPA').textContent = gpa;
            document.getElementById('choiceCourse').textContent = state.courseType === 'quantitative' ? 'Quantitative (Math/Statistics intensive)' : 'Qualitative (writing intensive)';

            // Update belief questions
            document.getElementById('beliefStudentName').textContent = name;
            document.getElementById('beliefStudentName2').textContent = name;
            document.getElementById('beliefStudentName3').textContent = name;

            // Update practice tip names
            document.getElementById('practiceTipName').textContent = name;
            document.getElementById('practiceTipName2').textContent = name;

            // Update WTP screen
            document.getElementById('wtpStudentName').textContent = name;
            document.getElementById('wtpStudentName2').textContent = name;
            document.getElementById('wtpStudentName3').textContent = name;
            document.getElementById('wtpStudentName4').textContent = name;

            // Update direct preference screen
            document.getElementById('directPrefName').textContent = name;
            document.getElementById('directPrefName2').textContent = name;
            document.getElementById('directPrefName3').textContent = name;

            // Update manipulation check screen
            document.getElementById('manipStudentName7').textContent = name;
            document.getElementById('manipStudentName8').textContent = name;

        }

        function submitPractice() {
            const p0 = parseInt(document.getElementById('practicePoints0').value) || 0;
            const p1 = parseInt(document.getElementById('practicePoints1').value) || 0;
            const p2 = parseInt(document.getElementById('practicePoints2').value) || 0;

            state.practiceResponse = { A: p0, B: p1, C: p2 };

            // Show confirmation
            alert(`Great! You allocated ${p0} to A, ${p1} to B, and ${p2} to C.\nIn the actual task, there are 9 choice sets. Ready to begin?`);

            // Start main task
            state.currentSetIndex = 0;
            renderChoiceSet();
            showScreen('choiceScreen');
        }

        // ============================================
        // PRACTICE SET RENDERING
        // ============================================
        function renderPracticeSet() {
            const practiceProfiles = [
                { ai: 'Banned', grading: '80/20', rating: 'HighQual' },
                { ai: 'Guided', grading: '50/50', rating: 'LowQual' },
                { ai: 'Unrestricted', grading: '80/20', rating: 'HighQual' }
            ];

            const container = document.getElementById('practiceCards');
            container.innerHTML = '';

            const labels = ['A', 'B', 'C'];
            practiceProfiles.forEach((profile, idx) => {
                const label = labels[idx];
                const card = createCard(profile, label, 'practice');
                container.appendChild(card);
            });
        }

        // ============================================
        // CHOICE SET RENDERING
        // ============================================
        function renderChoiceSet() {
            const choiceSet = state.choiceSets[state.currentSetIndex];
            const labelOrder = state.sectionLabelOrders[state.currentSetIndex];
            const labels = ['A', 'B', 'C'];

            // Update header
            document.getElementById('setNumber').textContent = state.currentSetIndex + 1;

            // Render cards
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';

            labelOrder.forEach((profileIdx, displayIdx) => {
                const profile = choiceSet.profiles[profileIdx];
                const label = labels[displayIdx];
                const card = createCard(profile, label, 'main');
                container.appendChild(card);
            });

            // Show/hide belief section
            const beliefSection = document.getElementById('beliefSection');
            if (state.beliefSets.includes(state.currentSetIndex)) {
                beliefSection.style.display = 'block';
                // Reset belief inputs
                state.currentBeliefs = {};
                document.querySelectorAll('.grade-option').forEach(opt => opt.classList.remove('selected'));
                document.getElementById('beliefHours').value = 8;
                updateHoursDisplay();
            } else {
                beliefSection.style.display = 'none';
            }

            // Update navigation buttons
            document.getElementById('prevBtn').style.visibility = state.currentSetIndex > 0 ? 'visible' : 'hidden';
            document.getElementById('nextBtn').textContent = state.currentSetIndex === 8 ? 'Finish' : 'Next';
            document.getElementById('nextBtn').disabled = true;

            // Reset points display
            document.getElementById('pointsTotal').textContent = '0 / 100';
            document.getElementById('pointsTotal').className = 'points-total invalid';
            document.getElementById('pointsMessage').textContent = 'Enter points for each section (must total exactly 100)';
            document.getElementById('pointsMessage').className = 'points-message';
        }

        function createCard(profile, label, mode) {
            const sectionClass = `section-${label.toLowerCase()}`;
            const prefix = mode === 'practice' ? 'practice' : '';
            const review = RATING_LABELS[profile.rating];

            const card = document.createElement('div');
            card.className = 'course-card';
            card.innerHTML = `
                <div class="card-header ${sectionClass}">Section ${label}</div>
                <div class="card-body">
                    <div class="attribute-row">
                        <span class="attr-label">AI Policy</span>
                        <span class="attr-value ${profile.ai.toLowerCase()}">${AI_LABELS[profile.ai]}</span>
                    </div>
                    <div class="attribute-row">
                        <span class="attr-label">Assessment Structure</span>
                        <span class="attr-value">${formatGrading(profile.grading)}</span>
                    </div>
                    <div class="attribute-row" style="flex-direction: column; align-items: flex-start;">
                        <span class="attr-label" style="margin-bottom: 8px;">Student Reviews</span>
                        <div style="display: flex; gap: 16px; margin-bottom: 6px;">
                            <span><strong>Quality:</strong> ${review.quality}</span>
                            <span><strong>Difficulty:</strong> ${review.difficulty}</span>
                        </div>
                        <span style="font-size: 0.85rem; color: #64748b; font-style: italic;">${review.summary}</span>
                    </div>
                </div>
                <div class="point-input-container">
                    <label>Points for Section ${label}</label>
                    <input type="number" class="point-input" id="${prefix}Points${['A', 'B', 'C'].indexOf(label)}"
                           min="0" max="100" placeholder="0" oninput="${mode === 'practice' ? 'validatePracticePoints()' : 'validatePoints()'}">
                </div>
            `;
            return card;
        }

        function formatGrading(grading) {
            if (grading === '80/20') return '80% Exam / 20% Take-Home';
            if (grading === '50/50') return '50% Exam / 50% Take-Home';
            return grading;
        }

        function validatePracticePoints() {
            const p0 = parseInt(document.getElementById('practicePoints0').value) || 0;
            const p1 = parseInt(document.getElementById('practicePoints1').value) || 0;
            const p2 = parseInt(document.getElementById('practicePoints2').value) || 0;
            const total = p0 + p1 + p2;

            const totalEl = document.getElementById('practiceTotal');
            const msgEl = document.getElementById('practiceMessage');
            const btn = document.getElementById('practiceBtn');

            totalEl.textContent = `${total} / 100`;

            if (total === 100) {
                totalEl.className = 'points-total valid';
                msgEl.textContent = 'Points add up to 100';
                msgEl.className = 'points-message';
                btn.disabled = false;
            } else {
                totalEl.className = 'points-total invalid';
                msgEl.textContent = total < 100 ? `Need ${100 - total} more points` : `${total - 100} points over limit`;
                msgEl.className = 'points-message error';
                btn.disabled = true;
            }
        }

        function validatePoints() {
            const p0 = parseInt(document.getElementById('Points0')?.value) || 0;
            const p1 = parseInt(document.getElementById('Points1')?.value) || 0;
            const p2 = parseInt(document.getElementById('Points2')?.value) || 0;
            const total = p0 + p1 + p2;

            const totalEl = document.getElementById('pointsTotal');
            const msgEl = document.getElementById('pointsMessage');
            const nextBtn = document.getElementById('nextBtn');

            totalEl.textContent = `${total} / 100`;

            if (total === 100) {
                totalEl.className = 'points-total valid';
                msgEl.textContent = 'Points add up to 100';
                msgEl.className = 'points-message';

                // Check belief questions if needed
                if (state.beliefSets.includes(state.currentSetIndex)) {
                    const hasGrade = state.currentBeliefs.grade;
                    const hasHours = state.currentBeliefs.hours !== undefined;

                    if (hasGrade && hasHours) {
                        nextBtn.disabled = false;
                    } else {
                        nextBtn.disabled = true;
                        msgEl.textContent = 'Please answer all follow-up questions below';
                        msgEl.className = 'points-message error';
                    }
                } else {
                    nextBtn.disabled = false;
                }
            } else {
                totalEl.className = 'points-total invalid';
                msgEl.textContent = total < 100 ? `Need ${100 - total} more points` : `${total - 100} points over limit`;
                msgEl.className = 'points-message error';
                nextBtn.disabled = true;
            }
        }

        function saveCurrentResponse() {
            const choiceSet = state.choiceSets[state.currentSetIndex];
            const labelOrder = state.sectionLabelOrders[state.currentSetIndex];
            const labels = ['A', 'B', 'C'];

            const p0 = parseInt(document.getElementById('Points0').value) || 0;
            const p1 = parseInt(document.getElementById('Points1').value) || 0;
            const p2 = parseInt(document.getElementById('Points2').value) || 0;

            const response = {
                setNumber: state.currentSetIndex + 1,
                setType: choiceSet.type,
                sections: labelOrder.map((profileIdx, displayIdx) => ({
                    label: labels[displayIdx],
                    profile: choiceSet.profiles[profileIdx],
                    points: [p0, p1, p2][displayIdx]
                }))
            };

            // Add belief data if applicable
            if (state.beliefSets.includes(state.currentSetIndex)) {
                response.beliefs = { ...state.currentBeliefs };
            }

            // Find existing or add new
            const existingIdx = state.choiceResponses.findIndex(r => r.setNumber === response.setNumber);
            if (existingIdx >= 0) {
                state.choiceResponses[existingIdx] = response;
            } else {
                state.choiceResponses.push(response);
            }
        }

        function nextSet() {
            saveCurrentResponse();

            // After set 2 (index 1), show name check
            if (state.currentSetIndex === 1 && !state.nameCheckShown) {
                state.nameCheckShown = true;
                showScreen('nameCheckScreen');
                return;
            }

            if (state.currentSetIndex < state.choiceSets.length - 1) {
                state.currentSetIndex++;
                renderChoiceSet();
                updateProgress();
            } else {
                // Check for speedster
                const duration = (Date.now() - state.startTime) / 1000 / 60; // minutes
                if (duration < 5) {
                    state.flags.speedster = true;
                }

                // Check for straightliner
                checkStraightliner();

                showScreen('directPrefScreen');
            }
        }

        function previousSet() {
            if (state.currentSetIndex > 0) {
                saveCurrentResponse();
                state.currentSetIndex--;
                renderChoiceSet();
                updateProgress();
            }
        }

        function submitNameCheck() {
            state.flags.attention_name = state.nameCheckAnswer !== state.studentName;

            // Continue to next choice set
            state.currentSetIndex++;
            renderChoiceSet();
            showScreen('choiceScreen');
        }

        function checkStraightliner() {
            // Check if same allocation pattern appears 6+ times
            const patterns = state.choiceResponses.map(r => {
                const pts = r.sections.map(s => s.points).sort((a, b) => b - a);
                return pts.join('-');
            });

            const patternCounts = {};
            patterns.forEach(p => {
                patternCounts[p] = (patternCounts[p] || 0) + 1;
            });

            if (Object.values(patternCounts).some(count => count >= 6)) {
                state.flags.straightliner = true;
            }
        }

        function validateDirectPref() {
            const most = document.querySelector('input[name="ai_pref_most"]:checked');
            const least = document.querySelector('input[name="ai_pref_least"]:checked');
            const btn = document.getElementById('directPrefBtn');

            if (most && least) {
                // Validate that most != least
                if (most.value === least.value) {
                    btn.disabled = true;
                    alert('Your most preferred and least preferred cannot be the same. Please adjust your selection.');
                } else {
                    btn.disabled = false;
                }
            } else {
                btn.disabled = true;
            }
        }

        function submitDirectPref() {
            const most = document.querySelector('input[name="ai_pref_most"]:checked').value;
            const least = document.querySelector('input[name="ai_pref_least"]:checked').value;

            state.directPref = { most, least };
            showScreen('wtpScreen');
        }

        function submitWTP() {
            state.wtpResponses = {
                money: document.querySelector('input[name="wtp_money"]:checked').value,
                time: document.querySelector('input[name="wtp_time"]:checked').value,
                free_likelihood: document.querySelector('input[name="wtp_free"]:checked').value
            };
            showScreen('manipCheckScreen');
        }

        function submitManipChecks() {
            const gpaAnswer = document.querySelector('input[name="manip_gpa"]:checked').value;
            const courseAnswer = document.querySelector('input[name="manip_course"]:checked').value;

            const correctGPA = state.studentAbility === 'high' ? '3.8' : '2.5';
            const correctCourse = state.courseType === 'quantitative' ? 'quant' : 'writing';

            state.manipChecks = {
                gpa_answer: gpaAnswer,
                gpa_correct: gpaAnswer === correctGPA,
                course_answer: courseAnswer,
                course_correct: courseAnswer === correctCourse
            };

            // Generate confirmation code
            document.getElementById('confirmationCode').textContent = state.respondentId;
            showScreen('completionScreen');
        }

        function downloadResults() {
            // Build comprehensive CSV
            let csv = `VIGNETTE STUDY RESPONSE DATA (V9)\n`;
            csv += `${'='.repeat(60)}\n\n`;

            // Summary
            csv += `RESPONDENT SUMMARY\n`;
            csv += `respondent_id,${state.respondentId}\n`;
            csv += `timestamp,${new Date().toISOString()}\n`;
            csv += `cell,${state.cell}\n`;
            csv += `block,${state.block}\n`;
            csv += `set_display_order,"${state.setDisplayOrder.join(',')}"\n`;
            csv += `student_ability,${state.studentAbility}\n`;
            csv += `course_type,${state.courseType}\n`;
            csv += `student_gender,${state.studentGender}\n`;
            csv += `student_name,${state.studentName}\n`;
            csv += `duration_minutes,${((Date.now() - state.startTime) / 1000 / 60).toFixed(2)}\n\n`;

            // Flags
            csv += `QUALITY FLAGS\n`;
            csv += `flag_comprehension,${state.flags.comprehension ? 1 : 0}\n`;
            csv += `flag_attention_name,${state.flags.attention_name ? 1 : 0}\n`;
                        csv += `flag_speedster,${state.flags.speedster ? 1 : 0}\n`;
            csv += `flag_straightliner,${state.flags.straightliner ? 1 : 0}\n\n`;

            // Demographics
            csv += `DEMOGRAPHICS\n`;
            Object.entries(state.demographics).forEach(([k, v]) => {
                csv += `${k},${v}\n`;
            });
            csv += `\n`;

            // AI Experience
            csv += `AI EXPERIENCE\n`;
            csv += `ai_frequency,${state.aiExperience.frequency}\n`;
            csv += `ai_tasks,"${state.aiExperience.tasks.join(', ')}"\n`;
            csv += `ai_skill,${state.aiExperience.skill}\n\n`;

            // Choice responses (one row per section = 27 rows)
            csv += `CHOICE RESPONSES\n`;
            csv += `display_position,original_set_id,set_type,display_section,profile_id,ai_policy,grading,rating,points\n`;
            state.choiceResponses.forEach((r, idx) => {
                const originalSetId = state.setDisplayOrder[idx];
                const setType = r.setType || 'unknown';
                r.sections.forEach(s => {
                    csv += `${r.setNumber},${originalSetId},${setType},${s.label},${s.profile.id},${s.profile.ai},${s.profile.grading},${s.profile.rating},${s.points}\n`;
                });
            });
            csv += `\n`;

            // Direct AI preference (validation measure)
            csv += `DIRECT AI PREFERENCE\n`;
            csv += `ai_pref_most,${state.directPref.most}\n`;
            csv += `ai_pref_least,${state.directPref.least}\n\n`;

            // WTP
            csv += `WTP RESPONSES\n`;
            csv += `wtp_money,${state.wtpResponses.money}\n`;
            csv += `wtp_time,${state.wtpResponses.time}\n`;
            csv += `wtp_free_likelihood,${state.wtpResponses.free_likelihood}\n\n`;

            // Manipulation checks
            csv += `MANIPULATION CHECKS\n`;
            csv += `manip_gpa_answer,${state.manipChecks.gpa_answer}\n`;
            csv += `manip_gpa_correct,${state.manipChecks.gpa_correct ? 1 : 0}\n`;
            csv += `manip_course_answer,${state.manipChecks.course_answer}\n`;
            csv += `manip_course_correct,${state.manipChecks.course_correct ? 1 : 0}\n\n`;

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vignette_response_v9_${state.respondentId}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress();
            renderPracticeSet();
        });
    </script>
</body>
</html>
